# æ™ºèƒ½ä½“æ§åˆ¶å°è¾“å‡ºè¯¦è§£ä¸è°ƒè¯•æŒ‡å—

> ğŸ“… åˆ›å»ºæ—¶é—´ï¼š2025-01-28  
> ğŸ·ï¸ æ ‡ç­¾ï¼šConsole, æ—¥å¿—ç³»ç»Ÿ, Rich, è°ƒè¯•, smolagents  
> ğŸ¯ é€‚ç”¨åœºæ™¯ï¼šsmolagentsè°ƒè¯•ã€æ—¥å¿—ç³»ç»Ÿç†è§£ã€è¾“å‡ºæ§åˆ¶

## ğŸ“– é—®é¢˜èƒŒæ™¯

åœ¨åˆ†æsmolagentsä¸­Liveç»„ä»¶ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬é‡åˆ°äº†è¿™è¡Œä»£ç ï¼š
```python
with Live("", console=self.logger.console, vertical_overflow="visible") as live:
```

å…¶ä¸­ `console=self.logger.console` çš„å«ä¹‰å’Œä¸ºä»€ä¹ˆæœ‰æ—¶å€™çœ‹ä¸åˆ°è¾“å‡ºï¼Œéœ€è¦æ·±å…¥ç†è§£ã€‚

## ğŸ” æ™ºèƒ½ä½“æ§åˆ¶å°ç³»ç»Ÿè§£æ

### 1. AgentLoggerçš„ç»“æ„

```python
# src/smolagents/monitoring.py
class AgentLogger:
    def __init__(self, level: LogLevel = LogLevel.INFO, console: Console | None = None):
        self.level = level
        if console is None:
            self.console = Console(highlight=False)  # ğŸ”¥ åˆ›å»ºæ–°çš„æ§åˆ¶å°
        else:
            self.console = console  # ğŸ”¥ ä½¿ç”¨ä¼ å…¥çš„æ§åˆ¶å°
```

**å…³é”®è¦ç‚¹ï¼š**
- æ¯ä¸ªæ™ºèƒ½ä½“éƒ½æœ‰è‡ªå·±çš„ `AgentLogger` å®ä¾‹
- `logger.console` æ˜¯ä¸€ä¸ª Rich Console å¯¹è±¡
- è¿™ä¸ªæ§åˆ¶å°è´Ÿè´£æ‰€æœ‰çš„è¾“å‡ºæ ¼å¼åŒ–å’Œæ˜¾ç¤º

### 2. æ§åˆ¶å°çš„å±‚çº§ç»“æ„

```python
# æ™ºèƒ½ä½“åˆå§‹åŒ–æ—¶
def __init__(self, ..., logger=None):
    if logger is None:
        self.logger = AgentLogger(level=verbosity_level)  # åˆ›å»ºæ–°logger
    else:
        self.logger = logger  # ä½¿ç”¨ä¼ å…¥çš„logger
```

**å±‚çº§å…³ç³»ï¼š**
```
æ™ºèƒ½ä½“å®ä¾‹ â†’ AgentLogger â†’ Rich Console â†’ ç»ˆç«¯è¾“å‡º
   â†“             â†“              â†“           â†“
 agent      agent.logger   logger.console  å±å¹•æ˜¾ç¤º
```

## ğŸ¯ ä¸ºä»€ä¹ˆæœ‰æ—¶å€™çœ‹ä¸åˆ°è¾“å‡º

### åŸå› 1ï¼šæ—¥å¿—çº§åˆ«è¿‡æ»¤

```python
# AgentLoggerä¸­çš„æ—¥å¿—è¿‡æ»¤
def log(self, *args, level: int | str | LogLevel = LogLevel.INFO, **kwargs):
    if level <= self.level:  # ğŸ”¥ åªæœ‰æ»¡è¶³çº§åˆ«è¦æ±‚æ‰è¾“å‡º
        self.console.print(*args, **kwargs)
```

**æ—¥å¿—çº§åˆ«ä¼˜å…ˆçº§ï¼š**
```python
class LogLevel(IntEnum):
    ERROR = 40
    WARNING = 30  
    INFO = 20
    DEBUG = 10
```

### åŸå› 2ï¼šæ§åˆ¶å°é‡å®šå‘

```python
# å¦‚æœæ™ºèƒ½ä½“ä½¿ç”¨äº†è‡ªå®šä¹‰æ§åˆ¶å°
custom_console = Console(file=StringIO())  # è¾“å‡ºåˆ°å†…å­˜ï¼Œä¸æ˜¾ç¤ºåœ¨å±å¹•
agent = CodeAgent(logger=AgentLogger(console=custom_console))
```

### åŸå› 3ï¼šLiveç»„ä»¶è¦†ç›–

```python
# Liveç»„ä»¶ä¼šå ç”¨æ§åˆ¶å°è¾“å‡ºåŒºåŸŸ
with Live() as live:
    # åœ¨Liveæ´»è·ƒæœŸé—´ï¼Œå…¶ä»–printè¾“å‡ºå¯èƒ½è¢«è¦†ç›–
    print("è¿™æ¡æ¶ˆæ¯å¯èƒ½çœ‹ä¸åˆ°")
    live.update("Liveå†…å®¹")
```

## ğŸ› ï¸ è°ƒè¯•å’ŒæŸ¥çœ‹è¾“å‡ºçš„æ–¹æ³•

è®©æˆ‘åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„è°ƒè¯•æ¼”ç¤ºï¼š

```python
import sys
from io import StringIO
from rich.console import Console
from smolagents.monitoring import AgentLogger, LogLevel

class ConsoleDebugDemo:
    """æ™ºèƒ½ä½“æ§åˆ¶å°è°ƒè¯•æ¼”ç¤º"""
    
    def demo_logger_levels(self):
        """æ¼”ç¤ºä¸åŒæ—¥å¿—çº§åˆ«çš„è¾“å‡º"""
        print("ğŸ¯ Demo 1: æ—¥å¿—çº§åˆ«è¿‡æ»¤æ¼”ç¤º")
        print("=" * 40)
        
        # åˆ›å»ºä¸åŒçº§åˆ«çš„logger
        loggers = {
            "ERRORçº§": AgentLogger(level=LogLevel.ERROR),
            "INFOçº§": AgentLogger(level=LogLevel.INFO),
            "DEBUGçº§": AgentLogger(level=LogLevel.DEBUG)
        }
        
        for name, logger in loggers.items():
            print(f"\nã€{name}åˆ«Loggerè¾“å‡ºã€‘")
            logger.log("è¿™æ˜¯ERRORæ¶ˆæ¯", level=LogLevel.ERROR)
            logger.log("è¿™æ˜¯INFOæ¶ˆæ¯", level=LogLevel.INFO) 
            logger.log("è¿™æ˜¯DEBUGæ¶ˆæ¯", level=LogLevel.DEBUG)
    
    def demo_console_capture(self):
        """æ¼”ç¤ºæ§åˆ¶å°è¾“å‡ºæ•è·"""
        print("\nğŸ¯ Demo 2: æ§åˆ¶å°è¾“å‡ºæ•è·")
        print("=" * 40)
        
        # æ­£å¸¸è¾“å‡ºåˆ°å±å¹•
        normal_console = Console()
        print("\nã€æ­£å¸¸è¾“å‡ºã€‘")
        normal_console.print("è¿™æ¡æ¶ˆæ¯æ˜¾ç¤ºåœ¨å±å¹•ä¸Š", style="green")
        
        # æ•è·è¾“å‡ºåˆ°å†…å­˜
        captured_output = StringIO()
        capture_console = Console(file=captured_output)
        
        capture_console.print("è¿™æ¡æ¶ˆæ¯è¢«æ•è·åˆ°å†…å­˜", style="red")
        capture_console.print("ç”¨æˆ·çœ‹ä¸åˆ°è¿™æ¡æ¶ˆæ¯", style="blue")
        
        print("\nã€æ•è·çš„å†…å®¹ã€‘")
        print(f"å†…å­˜ä¸­çš„å†…å®¹: '{captured_output.getvalue().strip()}'")
    
    def demo_live_console_sharing(self):
        """æ¼”ç¤ºLiveç»„ä»¶å…±äº«æ§åˆ¶å°"""
        print("\nğŸ¯ Demo 3: Liveä¸Loggerå…±äº«æ§åˆ¶å°")
        print("=" * 40)
        
        # åˆ›å»ºå…±äº«æ§åˆ¶å°
        shared_console = Console()
        logger = AgentLogger(console=shared_console)
        
        print("\nå¼€å§‹Liveæ¼”ç¤º...")
        
        # æ¨¡æ‹Ÿsmolagentsçš„ä½¿ç”¨æ–¹å¼
        from rich.live import Live
        from rich.markdown import Markdown
        import time
        
        with Live("", console=shared_console, vertical_overflow="visible") as live:
            content = ""
            steps = ["# è§„åˆ’ä¸­\n\n", "## æ­¥éª¤1\n", "åˆ†æé—®é¢˜\n\n", "## æ­¥éª¤2\n", "ç”Ÿæˆæ–¹æ¡ˆ\n"]
            
            for step in steps:
                content += step
                live.update(Markdown(content))
                time.sleep(1)
        
        # Liveç»“æŸåï¼Œloggerå¯ä»¥æ­£å¸¸è¾“å‡º
        logger.log("Liveæ¼”ç¤ºå®Œæˆï¼", style="green bold")
    
    def demo_output_debugging(self):
        """è¾“å‡ºè°ƒè¯•æŠ€å·§æ¼”ç¤º"""
        print("\nğŸ¯ Demo 4: è¾“å‡ºè°ƒè¯•æŠ€å·§")
        print("=" * 40)
        
        # æŠ€å·§1: æ£€æŸ¥æ§åˆ¶å°å¯¹è±¡
        logger = AgentLogger()
        print(f"æ§åˆ¶å°å¯¹è±¡: {logger.console}")
        print(f"è¾“å‡ºæ–‡ä»¶: {logger.console.file}")
        print(f"æ˜¯å¦ä¸ºç»ˆç«¯: {logger.console.is_terminal}")
        
        # æŠ€å·§2: å¼ºåˆ¶åˆ·æ–°è¾“å‡º
        logger.console.print("å¼ºåˆ¶åˆ·æ–°çš„æ¶ˆæ¯")
        logger.console.file.flush()  # å¼ºåˆ¶åˆ·æ–°ç¼“å†²åŒº
        
        # æŠ€å·§3: æ£€æŸ¥æ—¥å¿—çº§åˆ«
        print(f"å½“å‰æ—¥å¿—çº§åˆ«: {logger.level}")
        
        # æŠ€å·§4: ä¸´æ—¶æ”¹å˜æ—¥å¿—çº§åˆ«
        original_level = logger.level
        logger.level = LogLevel.DEBUG
        logger.log("ç°åœ¨å¯ä»¥çœ‹åˆ°DEBUGæ¶ˆæ¯äº†", level=LogLevel.DEBUG)
        logger.level = original_level
    
    def run_all_demos(self):
        """è¿è¡Œæ‰€æœ‰æ¼”ç¤º"""
        try:
            self.demo_logger_levels()
            self.demo_console_capture()
            self.demo_live_console_sharing()
            self.demo_output_debugging()
            print("\nğŸ‰ æ‰€æœ‰æ¼”ç¤ºå®Œæˆï¼")
        except Exception as e:
            print(f"âŒ æ¼”ç¤ºå‡ºé”™: {e}")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    demo = ConsoleDebugDemo()
    demo.run_all_demos()
```

## ğŸ”§ å®é™…é—®é¢˜è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šæ£€æŸ¥æ—¥å¿—çº§åˆ«
```python
# æ£€æŸ¥æ™ºèƒ½ä½“çš„æ—¥å¿—çº§åˆ«
agent = CodeAgent(...)
print(f"å½“å‰æ—¥å¿—çº§åˆ«: {agent.logger.level}")

# å¦‚æœçº§åˆ«å¤ªé«˜ï¼Œé™ä½çº§åˆ«
agent.logger.level = LogLevel.DEBUG
```

### æ–¹æ¡ˆ2ï¼šæ˜¾å¼åˆ›å»ºå¯è§æ§åˆ¶å°
```python
from rich.console import Console

# åˆ›å»ºæ˜ç¡®è¾“å‡ºåˆ°stdoutçš„æ§åˆ¶å°
visible_console = Console(file=sys.stdout)
logger = AgentLogger(console=visible_console)
agent = CodeAgent(logger=logger)
```

### æ–¹æ¡ˆ3ï¼šæ•è·å’Œæ˜¾ç¤ºå†…éƒ¨è¾“å‡º
```python
# å¦‚æœè¾“å‡ºè¢«é‡å®šå‘ï¼Œå¯ä»¥æ‰‹åŠ¨è·å–
def capture_agent_output(agent, task):
    # ä¸´æ—¶æ›¿æ¢æ§åˆ¶å°
    original_console = agent.logger.console
    
    captured_output = StringIO()
    capture_console = Console(file=captured_output)
    agent.logger.console = capture_console
    
    # æ‰§è¡Œä»»åŠ¡
    result = agent.run(task)
    
    # æ¢å¤åŸæ§åˆ¶å°å¹¶æ˜¾ç¤ºæ•è·çš„å†…å®¹
    agent.logger.console = original_console
    captured_content = captured_output.getvalue()
    
    print("æ•è·çš„å†…éƒ¨è¾“å‡º:")
    print(captured_content)
    
    return result
```

### æ–¹æ¡ˆ4ï¼šå¼ºåˆ¶æ˜¾ç¤ºLiveå†…å®¹
```python
# åœ¨Liveä¹‹å¤–åŒæ—¶æ˜¾ç¤ºç›¸åŒå†…å®¹
with Live("", console=agent.logger.console) as live:
    for event in output_stream:
        content += event.content
        live.update(Markdown(content))
        
        # åŒæ—¶åœ¨å¦ä¸€ä¸ªæ§åˆ¶å°æ˜¾ç¤º
        debug_console = Console()
        debug_console.print(f"æ–°å¢å†…å®¹: {event.content}")
```

## ğŸ“Š è¾“å‡ºå¯è§æ€§è¯Šæ–­è¡¨

| æƒ…å†µ | ç°è±¡ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|------|----------|
| å®Œå…¨çœ‹ä¸åˆ°è¾“å‡º | é™é»˜è¿è¡Œ | æ—¥å¿—çº§åˆ«å¤ªé«˜ | é™ä½logger.level |
| åªçœ‹åˆ°æœ€ç»ˆç»“æœ | æ— ä¸­é—´è¿‡ç¨‹ | Liveç»„ä»¶è¦†ç›– | æ£€æŸ¥Liveé…ç½® |
| è¾“å‡ºæ ¼å¼æ··ä¹± | æ–‡å­—é‡å  | å¤šä¸ªæ§åˆ¶å°å†²çª | ç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ªæ§åˆ¶å° |
| è¾“å‡ºå»¶è¿Ÿæ˜¾ç¤º | æ‰¹é‡å‡ºç° | ç¼“å†²åŒºæœªåˆ·æ–° | è°ƒç”¨flush() |

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å¼€å‘è°ƒè¯•æ—¶
```python
# åˆ›å»ºé«˜å¯è§æ€§çš„æ™ºèƒ½ä½“
debug_console = Console(file=sys.stdout, force_terminal=True)
debug_logger = AgentLogger(level=LogLevel.DEBUG, console=debug_console)
agent = CodeAgent(logger=debug_logger)
```

### 2. ç”Ÿäº§ç¯å¢ƒ
```python
# ä½¿ç”¨åˆé€‚çš„æ—¥å¿—çº§åˆ«
production_logger = AgentLogger(level=LogLevel.INFO)
agent = CodeAgent(logger=production_logger)
```

### 3. æµ‹è¯•ç¯å¢ƒ
```python
# æ•è·è¾“å‡ºè¿›è¡Œæ–­è¨€
test_output = StringIO()
test_console = Console(file=test_output)
test_logger = AgentLogger(console=test_console)
agent = CodeAgent(logger=test_logger)

# æ‰§è¡Œå¹¶æ£€æŸ¥è¾“å‡º
agent.run("æµ‹è¯•ä»»åŠ¡")
output_content = test_output.getvalue()
assert "æœŸæœ›çš„å†…å®¹" in output_content
```

## ğŸ† æ€»ç»“

**`console=self.logger.console` çš„ä½œç”¨ï¼š**

1. **ç»Ÿä¸€è¾“å‡ºç®¡é“**ï¼šç¡®ä¿Liveç»„ä»¶å’ŒLoggerä½¿ç”¨åŒä¸€ä¸ªæ§åˆ¶å°ï¼Œé¿å…è¾“å‡ºå†²çª
2. **æ ¼å¼ä¸€è‡´æ€§**ï¼šä¿æŒæ•´ä¸ªæ™ºèƒ½ä½“è¾“å‡ºçš„è§†è§‰é£æ ¼ç»Ÿä¸€
3. **è¾“å‡ºæ§åˆ¶**ï¼šå¯ä»¥é€šè¿‡loggerçš„æ§åˆ¶å°è®¾ç½®æ¥æ§åˆ¶Liveçš„è¾“å‡ºè¡Œä¸º

**ä¸ºä»€ä¹ˆæœ‰æ—¶å€™çœ‹ä¸åˆ°è¾“å‡ºï¼š**

1. **æ—¥å¿—çº§åˆ«è¿‡æ»¤**ï¼šè¾“å‡ºè¢«æ—¥å¿—çº§åˆ«é™åˆ¶
2. **æ§åˆ¶å°é‡å®šå‘**ï¼šè¾“å‡ºè¢«é‡å®šå‘åˆ°éæ˜¾ç¤ºè®¾å¤‡
3. **Liveç»„ä»¶è¦†ç›–**ï¼šLiveæ´»è·ƒæ—¶è¦†ç›–å…¶ä»–è¾“å‡º
4. **ç¼“å†²åŒºé—®é¢˜**ï¼šè¾“å‡ºè¢«ç¼“å­˜æœªåŠæ—¶æ˜¾ç¤º

**è°ƒè¯•å»ºè®®ï¼š**

1. æ£€æŸ¥ `agent.logger.level` ç¡®ä¿çº§åˆ«åˆé€‚
2. æ£€æŸ¥ `agent.logger.console.file` ç¡®ä¿è¾“å‡ºåˆ°æ­£ç¡®ä½ç½®
3. åœ¨å¼€å‘æ—¶ä½¿ç”¨ `LogLevel.DEBUG` çº§åˆ«
4. ä½¿ç”¨æ˜¾å¼çš„ `sys.stdout` æ§åˆ¶å°è¿›è¡Œè°ƒè¯•

---

*ç†è§£æ™ºèƒ½ä½“çš„æ§åˆ¶å°ç³»ç»Ÿæ˜¯è°ƒè¯•smolagentsåº”ç”¨çš„å…³é”®æŠ€èƒ½ï¼*