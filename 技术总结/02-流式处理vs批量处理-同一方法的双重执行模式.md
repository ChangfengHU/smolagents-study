# æµå¼å¤„ç†vsæ‰¹é‡å¤„ç†ï¼šåŒä¸€æ–¹æ³•çš„åŒé‡æ‰§è¡Œæ¨¡å¼

> ğŸ“… åˆ›å»ºæ—¶é—´ï¼š2025-01-28  
> ğŸ·ï¸ æ ‡ç­¾ï¼šPython, æµå¼å¤„ç†, ç”Ÿæˆå™¨, æ‰§è¡Œæ¨¡å¼, ç”¨æˆ·ä½“éªŒ  
> ğŸ¯ é€‚ç”¨åœºæ™¯ï¼šAIæ™ºèƒ½ä½“å¼€å‘ã€å®æ—¶åº”ç”¨ã€APIè®¾è®¡

## ğŸ“– èƒŒæ™¯

åœ¨åˆ†æsmolagentsçš„`run`æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å‘ç°ä¸€ä¸ªæœ‰è¶£çš„è®¾è®¡ï¼šæ— è®º`stream`å‚æ•°æ˜¯Trueè¿˜æ˜¯Falseï¼Œåº•å±‚éƒ½è°ƒç”¨åŒä¸€ä¸ª`_run_stream`æ–¹æ³•ã€‚è¿™ç§è®¾è®¡çœ‹ä¼¼å†—ä½™ï¼Œå®é™…ä¸Šä½“ç°äº†è½¯ä»¶æ¶æ„ä¸­çš„ä¸€ä¸ªé‡è¦æ¨¡å¼ï¼š**åŒä¸€æ ¸å¿ƒé€»è¾‘ï¼Œæ”¯æŒå¤šç§æ‰§è¡Œæ¨¡å¼**ã€‚

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

```python
def run(self, task, stream=False):
    if stream:
        # æµå¼æ¨¡å¼
        return self._run_stream(task=self.task, max_steps=max_steps, images=images)
    else:
        # æ‰¹é‡æ¨¡å¼  
        steps = list(self._run_stream(task=self.task, max_steps=max_steps, images=images))
        return steps[-1].output
```

**ç–‘é—®**ï¼šæ—¢ç„¶éƒ½è°ƒç”¨`_run_stream`ï¼Œä¸ºä»€ä¹ˆéœ€è¦ä¸¤ç§æ¨¡å¼ï¼Ÿå·®å¼‚åœ¨å“ªé‡Œï¼Ÿ

## ğŸ’¡ æ ¸å¿ƒå·®å¼‚åˆ†æ

### 1. è¿”å›ç±»å‹çš„æœ¬è´¨åŒºåˆ«

```python
# stream=Trueï¼šè¿”å›Generatorå¯¹è±¡
generator_obj = self._run_stream(...)  # æƒ°æ€§å¯¹è±¡ï¼Œæœªæ‰§è¡Œ
type(generator_obj)  # <class 'generator'>

# stream=Falseï¼šè¿”å›å…·ä½“å€¼
steps_list = list(self._run_stream(...))  # å¼ºåˆ¶æ‰§è¡Œï¼Œè¿”å›åˆ—è¡¨
final_result = steps_list[-1].output  # æå–æœ€ç»ˆç»“æœ
type(final_result)  # <class 'str'> æˆ–å…¶ä»–å…·ä½“ç±»å‹
```

### 2. æ‰§è¡Œæ—¶æœºçš„å…³é”®å·®å¼‚

#### ğŸš€ æµå¼æ¨¡å¼ï¼šå»¶è¿Ÿæ‰§è¡Œ
```python
# è°ƒç”¨ç¬é—´
start_time = time.time()
stream_result = agent.run("å¤æ‚ä»»åŠ¡", stream=True)
call_time = time.time() - start_time
print(f"è°ƒç”¨è€—æ—¶: {call_time:.3f}ç§’")  # è¾“å‡º: 0.001ç§’

# å®é™…æ‰§è¡Œ
for step in stream_result:  # è¿™é‡Œæ‰å¼€å§‹çœŸæ­£æ‰§è¡Œ
    print(step)
```

#### â³ æ‰¹é‡æ¨¡å¼ï¼šç«‹å³æ‰§è¡Œ
```python  
# è°ƒç”¨æœŸé—´å°±å®Œæˆæ‰€æœ‰æ‰§è¡Œ
start_time = time.time()
batch_result = agent.run("å¤æ‚ä»»åŠ¡", stream=False)  # è¿™é‡Œä¼šé˜»å¡
call_time = time.time() - start_time
print(f"è°ƒç”¨è€—æ—¶: {call_time:.3f}ç§’")  # è¾“å‡º: 10.245ç§’

print(f"æœ€ç»ˆç»“æœ: {batch_result}")
```

## ğŸ” `list()` å‡½æ•°çš„å…³é”®ä½œç”¨

```python
steps = list(self._run_stream(...))
```

**`list()`åœ¨è¿™é‡Œçš„ä¸‰é‡ä½œç”¨ï¼š**

### 1. å¼ºåˆ¶æ‰§è¡Œç”Ÿæˆå™¨
```python
# ä¸ä½¿ç”¨list() - æƒ°æ€§æ‰§è¡Œ
gen = self._run_stream(...)  # åˆ›å»ºç”Ÿæˆå™¨ï¼Œæœªæ‰§è¡Œ
# ä»»åŠ¡å®é™…ä¸Šè¿˜æ²¡å¼€å§‹ï¼

# ä½¿ç”¨list() - ç«‹å³æ‰§è¡Œ
steps = list(self._run_stream(...))  # è€—å°½ç”Ÿæˆå™¨ï¼Œæ‰§è¡Œå®Œæ‰€æœ‰æ­¥éª¤
# ä»»åŠ¡å·²ç»å…¨éƒ¨å®Œæˆï¼
```

### 2. å†…å­˜å­˜å‚¨æ‰€æœ‰æ­¥éª¤
```python
# æµå¼æ¨¡å¼ï¼šå†…å­˜ä¸­åªæœ‰å½“å‰æ­¥éª¤
for step in self._run_stream(...):
    process(step)  # å¤„ç†å®Œå°±é‡Šæ”¾

# æ‰¹é‡æ¨¡å¼ï¼šå†…å­˜ä¸­å­˜å‚¨æ‰€æœ‰æ­¥éª¤
steps = list(self._run_stream(...))  # æ‰€æœ‰æ­¥éª¤éƒ½åœ¨å†…å­˜ä¸­
```

### 3. é˜»å¡ç­‰å¾…å®Œæˆ
```python
# æµå¼ï¼šéé˜»å¡
stream = self._run_stream(...)  # ç«‹å³è¿”å›ï¼Œæ— é˜»å¡
# ç”¨æˆ·å¯ä»¥éšæ—¶åœæ­¢æˆ–æš‚åœ

# æ‰¹é‡ï¼šé˜»å¡ç­‰å¾…
steps = list(self._run_stream(...))  # å¿…é¡»ç­‰å¾…æ‰€æœ‰æ­¥éª¤å®Œæˆ
# ç”¨æˆ·æ— æ³•ä¸­é€”å¹²é¢„
```

## ğŸ¬ å®é™…æ‰§è¡Œæµç¨‹å¯¹æ¯”

### åœºæ™¯ï¼šæ™ºèƒ½ä½“æ‰§è¡Œä¸€ä¸ªéœ€è¦5ç§’çš„ä»»åŠ¡

#### æµå¼æ¨¡å¼æ‰§è¡Œæ—¶åº
```python
# ç”¨æˆ·ä»£ç 
agent_stream = agent.run("åˆ†ææ•°æ®", stream=True)
print("å¼€å§‹æ‰§è¡Œ...")

for step in agent_stream:
    print(f"[{time.strftime('%H:%M:%S')}] {step}")

# æ‰§è¡Œæ—¶åºï¼š
# 14:30:00.001 - runæ–¹æ³•è¿”å›ç”Ÿæˆå™¨å¯¹è±¡
# 14:30:00.002 - æ‰“å°"å¼€å§‹æ‰§è¡Œ..."
# 14:30:00.100 - ç¬¬1ä¸ªyieldï¼šå¼€å§‹åˆ¶å®šè®¡åˆ’
# 14:30:01.200 - ç¬¬2ä¸ªyieldï¼šè®¡åˆ’åˆ¶å®šå®Œæˆ
# 14:30:02.500 - ç¬¬3ä¸ªyieldï¼šå¼€å§‹æ‰§è¡Œæ­¥éª¤1
# 14:30:04.800 - ç¬¬4ä¸ªyieldï¼šæ­¥éª¤1å®Œæˆ
# 14:30:05.000 - ç¬¬5ä¸ªyieldï¼šä»»åŠ¡å®Œæˆ
```

#### æ‰¹é‡æ¨¡å¼æ‰§è¡Œæ—¶åº
```python
# ç”¨æˆ·ä»£ç 
print("å¼€å§‹æ‰§è¡Œ...")
result = agent.run("åˆ†ææ•°æ®", stream=False)
print(f"æ‰§è¡Œå®Œæˆ: {result}")

# æ‰§è¡Œæ—¶åºï¼š
# 14:30:00.001 - æ‰“å°"å¼€å§‹æ‰§è¡Œ..."
# 14:30:00.002 - è¿›å…¥runæ–¹æ³•
# 14:30:00.100 - å†…éƒ¨æ‰§è¡Œï¼šåˆ¶å®šè®¡åˆ’
# 14:30:01.200 - å†…éƒ¨æ‰§è¡Œï¼šè®¡åˆ’å®Œæˆ
# 14:30:02.500 - å†…éƒ¨æ‰§è¡Œï¼šæ‰§è¡Œæ­¥éª¤1
# 14:30:04.800 - å†…éƒ¨æ‰§è¡Œï¼šæ­¥éª¤1å®Œæˆ
# 14:30:05.000 - å†…éƒ¨æ‰§è¡Œï¼šä»»åŠ¡å®Œæˆ
# 14:30:05.001 - runæ–¹æ³•è¿”å›ç»“æœ
# 14:30:05.002 - æ‰“å°"æ‰§è¡Œå®Œæˆ: ..."
```

## ğŸ†š ç”¨æˆ·ä½“éªŒå¯¹æ¯”

### çœŸå®åœºæ™¯ï¼šå¤æ‚æ•°æ®åˆ†æä»»åŠ¡ï¼ˆè€—æ—¶10ç§’ï¼‰

#### æµå¼æ¨¡å¼ç”¨æˆ·ä½“éªŒï¼š
```
ç”¨æˆ·: è¯·åˆ†æè¿™ä¸ªæ•°æ®é›†
æ™ºèƒ½ä½“: [14:30:01] ğŸ¤” å¼€å§‹åˆ†æä»»åŠ¡éœ€æ±‚...
æ™ºèƒ½ä½“: [14:30:01] ğŸ“‹ åˆ¶å®šåˆ†æè®¡åˆ’ï¼šåˆ†4æ­¥æ‰§è¡Œ
æ™ºèƒ½ä½“: [14:30:02] ğŸ” æ­¥éª¤1ï¼šåŠ è½½æ•°æ®é›†...
æ™ºèƒ½ä½“: [14:30:04] âœ… æ•°æ®åŠ è½½å®Œæˆï¼Œå…±1000æ¡è®°å½•
æ™ºèƒ½ä½“: [14:30:05] ğŸ“Š æ­¥éª¤2ï¼šæ•°æ®æ¸…æ´—å’Œé¢„å¤„ç†...
æ™ºèƒ½ä½“: [14:30:07] âœ… æ•°æ®æ¸…æ´—å®Œæˆï¼Œç§»é™¤50æ¡å¼‚å¸¸æ•°æ®
æ™ºèƒ½ä½“: [14:30:08] ğŸ§® æ­¥éª¤3ï¼šç»Ÿè®¡åˆ†æ...
æ™ºèƒ½ä½“: [14:30:10] âœ… åˆ†æå®Œæˆï¼Œå‘ç°3ä¸ªå…³é”®è¶‹åŠ¿
æ™ºèƒ½ä½“: [14:30:11] ğŸ“ æ­¥éª¤4ï¼šç”Ÿæˆåˆ†ææŠ¥å‘Š...
æ™ºèƒ½ä½“: [14:30:11] âœ… åˆ†æå®Œæˆï¼å‘ç°äº†ä»¥ä¸‹å…³é”®è¶‹åŠ¿...
```

#### æ‰¹é‡æ¨¡å¼ç”¨æˆ·ä½“éªŒï¼š
```
ç”¨æˆ·: è¯·åˆ†æè¿™ä¸ªæ•°æ®é›†
(ç­‰å¾…11ç§’ï¼Œæ²¡æœ‰ä»»ä½•åé¦ˆ...)
æ™ºèƒ½ä½“: åˆ†æå®Œæˆï¼å‘ç°äº†ä»¥ä¸‹å…³é”®è¶‹åŠ¿...
```

## ğŸ› ï¸ æ¶æ„è®¾è®¡ä¼˜åŠ¿

### 1. ä»£ç å¤ç”¨
```python
def _run_stream(self):
    """æ ¸å¿ƒæ‰§è¡Œé€»è¾‘ - å•ä¸€èŒè´£"""
    yield PlanningStep(...)
    yield ActionStep(...)
    yield FinalStep(...)

def run(self, stream=False):
    """ç”¨æˆ·æ¥å£å±‚ - é€‚é…ä¸åŒä½¿ç”¨æ¨¡å¼"""
    if stream:
        return self._run_stream()  # ç›´æ¥è¿”å›ç”Ÿæˆå™¨
    else:
        return list(self._run_stream())[-1].output  # è½¬æ¢ä¸ºæœ€ç»ˆç»“æœ
```

**ä¼˜åŠ¿ï¼š**
- âœ… **DRYåŸåˆ™**ï¼šæ ¸å¿ƒé€»è¾‘åªå†™ä¸€é
- âœ… **ç»´æŠ¤æ€§**ï¼šä¿®æ”¹é€»è¾‘åªéœ€æ”¹ä¸€å¤„
- âœ… **æµ‹è¯•æ€§**ï¼šåªéœ€æµ‹è¯•ä¸€å¥—æ ¸å¿ƒé€»è¾‘

### 2. çµæ´»çš„æ¥å£è®¾è®¡
```python
# APIè®¾è®¡è€…çš„è§†è§’
class Agent:
    def run(self, task, stream=False):
        """
        ç»Ÿä¸€æ¥å£ï¼Œæ”¯æŒä¸¤ç§ä½¿ç”¨æ¨¡å¼ï¼š
        - stream=True: é€‚åˆäº¤äº’å¼åº”ç”¨
        - stream=False: é€‚åˆæ‰¹å¤„ç†åº”ç”¨
        """
```

## ğŸ“Š æ€§èƒ½ç‰¹å¾å¯¹æ¯”

| ç‰¹å¾ç»´åº¦ | æµå¼æ¨¡å¼ (stream=True) | æ‰¹é‡æ¨¡å¼ (stream=False) |
|----------|----------------------|----------------------|
| **å†…å­˜å ç”¨** | ğŸŸ¢ ä½ (åªå­˜å½“å‰æ­¥éª¤) | ğŸ”´ é«˜ (å­˜å‚¨æ‰€æœ‰æ­¥éª¤) |
| **é¦–æ¬¡å“åº”** | ğŸŸ¢ å¿« (~1ms) | ğŸ”´ æ…¢ (å®Œæ•´æ‰§è¡Œæ—¶é—´) |
| **ç”¨æˆ·åé¦ˆ** | ğŸŸ¢ å®æ—¶è¿›åº¦æ˜¾ç¤º | ğŸ”´ æ‰§è¡ŒæœŸé—´æ— åé¦ˆ |
| **å¯ä¸­æ–­æ€§** | ğŸŸ¢ å¯éšæ—¶åœæ­¢ | ğŸ”´ æ— æ³•ä¸­é€”åœæ­¢ |
| **é”™è¯¯å¤„ç†** | ğŸŸ¢ å¯é€æ­¥å¤„ç†é”™è¯¯ | ğŸ”´ é”™è¯¯ä¼šä¸­æ–­æ•´ä¸ªæµç¨‹ |
| **é›†æˆå¤æ‚åº¦** | ğŸ”´ éœ€è¦å¤„ç†è¿­ä»£å™¨ | ğŸŸ¢ ç®€å•ï¼Œç›´æ¥è·å–ç»“æœ |
| **è°ƒè¯•éš¾åº¦** | ğŸŸ¢ å¯è§‚å¯Ÿæ¯ä¸ªæ­¥éª¤ | ğŸ”´ åªèƒ½çœ‹åˆ°æœ€ç»ˆç»“æœ |

## ğŸ¯ æœ€ä½³å®è·µæŒ‡å—

### ä½•æ—¶é€‰æ‹©æµå¼æ¨¡å¼ (stream=True)

#### âœ… æ¨èåœºæ™¯
```python
# 1. äº¤äº’å¼åº”ç”¨
def chat_with_agent():
    for response in agent.run(user_input, stream=True):
        print(response)  # å®æ—¶æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹

# 2. é•¿æ—¶é—´ä»»åŠ¡  
def complex_analysis():
    for step in agent.run("åˆ†æå¤§æ•°æ®é›†", stream=True):
        update_progress_bar(step)  # æ›´æ–°è¿›åº¦æ¡

# 3. å¯ä¸­æ–­ä»»åŠ¡
def interruptible_task():
    try:
        for step in agent.run(task, stream=True):
            if user_wants_to_stop():
                break  # å¯ä»¥éšæ—¶åœæ­¢
            display(step)
    except KeyboardInterrupt:
        print("ä»»åŠ¡è¢«ç”¨æˆ·ä¸­æ–­")
```

#### âŒ ä¸æ¨èåœºæ™¯
```python
# ä¸æ¨èï¼šç®€å•çš„æ‰¹é‡å¤„ç†
def batch_process_files():
    for file in files:
        # è¿™é‡Œä¸éœ€è¦çœ‹åˆ°æ¯ä¸ªæ­¥éª¤
        result = agent.run(f"å¤„ç†{file}", stream=True)  # è¿‡äºå¤æ‚
        list(result)  # æœ€åè¿˜æ˜¯è¦è½¬æ¢ä¸ºåˆ—è¡¨
```

### ä½•æ—¶é€‰æ‹©æ‰¹é‡æ¨¡å¼ (stream=False)

#### âœ… æ¨èåœºæ™¯
```python
# 1. APIæœåŠ¡
@app.post("/analyze")
def analyze_data(data):
    result = agent.run(f"åˆ†ææ•°æ®: {data}", stream=False)
    return {"result": result}  # åªè¿”å›æœ€ç»ˆç»“æœ

# 2. æµ‹è¯•ç”¨ä¾‹
def test_agent_analysis():
    result = agent.run("æµ‹è¯•ä»»åŠ¡", stream=False)
    assert "æœŸæœ›ç»“æœ" in result

# 3. æ‰¹é‡å¤„ç†
def process_all_files():
    results = []
    for file in files:
        result = agent.run(f"å¤„ç†{file}", stream=False)
        results.append(result)
    return results
```

## ğŸ”§ å®ç°æ¨¡å¼æ€»ç»“

è¿™ç§è®¾è®¡ä½“ç°äº†å‡ ä¸ªé‡è¦çš„è½¯ä»¶å·¥ç¨‹åŸåˆ™ï¼š

### 1. å…³æ³¨ç‚¹åˆ†ç¦»
- `_run_stream()`: è´Ÿè´£æ ¸å¿ƒæ‰§è¡Œé€»è¾‘
- `run()`: è´Ÿè´£ç”¨æˆ·æ¥å£é€‚é…

### 2. å¼€é—­åŸåˆ™  
- å¯¹æ‰©å±•å¼€æ”¾ï¼šå¯ä»¥è½»æ¾æ·»åŠ æ–°çš„æ‰§è¡Œæ¨¡å¼
- å¯¹ä¿®æ”¹å°é—­ï¼šæ ¸å¿ƒæ‰§è¡Œé€»è¾‘æ— éœ€æ”¹åŠ¨

### 3. é‡Œæ°æ›¿æ¢åŸåˆ™
- ä¸¤ç§æ¨¡å¼åœ¨è¯­ä¹‰ä¸Šä¿æŒä¸€è‡´
- ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦åˆ‡æ¢æ¨¡å¼

## ğŸ† æ€»ç»“

è™½ç„¶`stream=True`å’Œ`stream=False`éƒ½è°ƒç”¨åŒä¸€ä¸ª`_run_stream`æ–¹æ³•ï¼Œä½†é€šè¿‡å·§å¦™çš„è®¾è®¡å®ç°äº†ï¼š

1. **ç›¸åŒçš„æ ¸å¿ƒé€»è¾‘**ï¼šé¿å…ä»£ç é‡å¤ï¼Œä¿è¯ä¸€è‡´æ€§
2. **ä¸åŒçš„æ‰§è¡Œè¯­ä¹‰**ï¼šæµå¼vsæ‰¹é‡ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚
3. **ä¼˜é›…çš„ç”¨æˆ·ä½“éªŒ**ï¼šä¸€ä¸ªå‚æ•°æ§åˆ¶ä¸¤ç§å®Œå…¨ä¸åŒçš„ä½¿ç”¨æ¨¡å¼

è¿™ç§è®¾è®¡æ¨¡å¼åœ¨ç°ä»£è½¯ä»¶å¼€å‘ä¸­éå¸¸å¸¸è§ï¼Œç‰¹åˆ«æ˜¯åœ¨éœ€è¦åŒæ—¶æ”¯æŒ**å®æ—¶å¤„ç†**å’Œ**æ‰¹é‡å¤„ç†**çš„ç³»ç»Ÿä¸­ã€‚å®ƒå®Œç¾åœ°å±•ç¤ºäº†å¦‚ä½•åœ¨ä¿æŒä»£ç ç®€æ´çš„åŒæ—¶ï¼Œæä¾›çµæ´»çš„ç”¨æˆ·æ¥å£ã€‚

**å…³é”®æ´å¯Ÿ**ï¼š`list()`ä¸ä»…ä»…æ˜¯ç±»å‹è½¬æ¢ï¼Œå®ƒæ˜¯**æ‰§è¡Œæ¨¡å¼çš„åˆ‡æ¢å™¨**â€”â€”å°†æƒ°æ€§çš„æµå¼æ‰§è¡Œè½¬æ¢ä¸ºç«‹å³çš„æ‰¹é‡æ‰§è¡Œã€‚

---

*æœ¬æ–‡æ¡£å±•ç¤ºäº†çœ‹ä¼¼ç®€å•çš„è®¾è®¡èƒŒåçš„æ·±å±‚æ€è€ƒï¼Œè¿™ç§æ¨¡å¼å€¼å¾—åœ¨è‡ªå·±çš„é¡¹ç›®ä¸­å€Ÿé‰´åº”ç”¨ã€‚*